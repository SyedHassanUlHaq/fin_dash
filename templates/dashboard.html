<!-- templates/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Equity Document Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #f9f9fb;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .badge {
            font-size: 0.85rem;
        }

        .table thead th {
            background-color: #f1f3f5;
        }

        .filter-select {
            border-radius: 8px;
        }

        .btn-primary {
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <h2 class="mb-4 text-center fw-bold">ðŸ“Š Equity Document Dashboard</h2>

        <!-- Upload JSON Card -->
        <div class="card mb-4 p-4">
            <h5 class="mb-3 fw-semibold">Upload JSON Metadata</h5>
            <form action="{% url 'upload_json' %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="row g-3 align-items-center">
                    <div class="col-md-10">
                        <input type="file" name="json_file" class="form-control" accept=".json" required>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" type="submit">Upload</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Filters -->
        <div class="card mb-4 p-4">
            <h5 class="mb-3 fw-semibold">Filters</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <select id="tickerFilter" class="form-select filter-select">
                        <option value="">All Tickers</option>
                        {% for ticker in tickers %}
                            <option value="{{ ticker }}">{{ ticker }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="typeFilter" class="form-select filter-select">
                        <option value="">All Content Types</option>
                        {% for t in content_types %}
                            <option value="{{ t }}">{{ t }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="periodicityFilter" class="form-select filter-select">
                        <option value="">All Periodicities</option>
                        <option value="periodic">Periodic</option>
                        <option value="non-periodic">Non-Periodic</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Table Card -->
        <div class="card p-4">
            <h5 class="mb-3 fw-semibold">Document Summary</h5>
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="documentTable">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">Ticker</th>
                            <th scope="col">Type</th>
                            <th scope="col">Year</th>
                            <th scope="col">Quarter</th>
                            <th scope="col">Published Date</th>
                            <th scope="col">Status</th>
                            <th scope="col">Link</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for doc in documents %}
                        <tr>
                            <td>{{ doc.equity_ticker }}</td>
                            <td>{{ doc.content_type }}</td>
                            <td>{{ doc.fiscal_year }}</td>
                            <td>{{ doc.fiscal_quarter|default:"â€”" }}</td>
                            <td>{{ doc.published_date|date:"Y-m-d" }}</td>
                            <td>
                                {% if doc.is_missing %}
                                    <span class="badge bg-danger">Missing</span>
                                {% else %}
                                    <span class="badge bg-success">Present</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if doc.r2_url %}
                                    <a href="{{ doc.r2_url }}" class="btn btn-sm btn-outline-primary" target="_blank">Open</a>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted">No documents available.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Optional: Filtering script -->
    <script>
        const filters = {
            ticker: document.getElementById('tickerFilter'),
            type: document.getElementById('typeFilter'),
            periodicity: document.getElementById('periodicityFilter'),
            table: document.getElementById('documentTable').getElementsByTagName('tbody')[0]
        };

        function applyFilters() {
            const rows = filters.table.getElementsByTagName('tr');
            const ticker = filters.ticker.value.toLowerCase();
            const type = filters.type.value.toLowerCase();
            const periodicity = filters.periodicity.value.toLowerCase();

            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                const show = (
                    (!ticker || cells[0].textContent.toLowerCase().includes(ticker)) &&
                    (!type || cells[1].textContent.toLowerCase().includes(type)) &&
                    (!periodicity || (periodicity === "periodic") === !cells[5].textContent.toLowerCase().includes("missing"))
                );
                row.style.display = show ? '' : 'none';
            }
        }

        filters.ticker.addEventListener('change', applyFilters);
        filters.type.addEventListener('change', applyFilters);
        filters.periodicity.addEventListener('change', applyFilters);
    </script>
</body>
</html>
